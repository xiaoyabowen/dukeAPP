<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>活动详情</title>
    <link rel="stylesheet" href="../../../css/api.css"/>
    <link rel="stylesheet" href="../../../css/commonWindow.css"/>
    <link rel="stylesheet" href="../../../css/mui.min.css">
    <link rel="stylesheet" href="../../../css/circleCommon.css">
    <style>
        #popover {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            position: fixed;
            left: 0;
            top: 0;
        }

        .popover_content {
            /*width: 70%;*/
            /*height: 3rem;*/
            /*background: #ffffff;*/
            border-radius: 0.08rem;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
<div id="details">
    <div class="isDisplay" id="box">
        <!--活动基本信息-->
        <div class="details_header">
            <div class="details_header_top">
                <div class="details_header_img">
                    <img src="../../../image/circle/circle01.png" alt="">
                </div>
                <div class="details_header_title">
                    <div class="details_title_con textOverflow">
                        {{item.title}}
                    </div>
                    <div class="details_sign">已报名 <span>{{item.count || 0}}</span></div>
                </div>
            </div>

            <div class="details_header_content">
                <div class="circle_tiem">活动时间: <span> {{item.c_from}}至{{item.c_to}}</span></div>
                <div class="circle_city" @click="cityHandle(item.latitude, item.longitude, item.shortname)">
                    活动地点: <span>
                        <!--{{item.province}}{{item.city}}{{item.street}}-->
                    {{item.shortname}}
                    </span>

                    <img src="../../../image/circle/locationx.png" alt="">
                </div>
                <div class="circle_city phone">
                    联系人: <span> {{item.phone}}</span>

                    <img src="../../../image/circle/phone2x.png" alt="">
                </div>
            </div>
        </div>
        <!--活动介绍-->
        <div class="details_content"></div>
        <!--活动参加人数-->
        <div class="details_comment_enrolled">
            <div class="details_enrolled_top">
                <span>已报名</span>
                <span>{{item.count || 0}}</span>
            </div>

            <div class="details_enrolled_content cssFlex">
                <div class="details_enrolled_item">
                    <img src="../../../image/pro.png" alt="">
                    <span>云闪信</span>
                </div>
                <div class="details_enrolled_item">
                    <img src="../../../image/pro.png" alt="">
                    <span>云闪信</span>
                </div>
                <div class="details_enrolled_item">
                    <img src="../../../image/pro.png" alt="">
                    <span>云闪信</span>
                </div>
                <div class="details_enrolled_item">
                    <img src="../../../image/pro.png" alt="">
                    <span>云闪信</span>
                </div>
                <div class="details_enrolled_item">
                    <img src="../../../image/pro.png" alt="">
                    <span>云闪信</span>
                </div>
                <div class="details_enrolled_item">
                    <img src="../../../image/pro.png" alt="">
                    <span>云闪信</span>
                </div>
            </div>
        </div>
        <!--活动评论-->
        <div class="details_comment" v-if="!edit">
            <div class="details_comment_title"><span>评论</span></div>
            <div class="details_comment_content">
                <div class="details_comment_top">
                    <img src="../../../image/pro.png" alt="">
                    <input type="text" @focus="focusHandle()" placeholder="我来说点什么...">
                </div>

                <div class="details_comment_item">
                    <div class="details_item_top">
                        <img src="../../../image/pro.png" alt="">
                        <span>微光</span>
                    </div>
                    <div class="details_item_con">
                        <p>据队友说你们组织的活动很好，早就想参加了，望你们的活动越办越好！</p>

                        <div class="details_item_bottom">
                            <span>2019/04/27</span>
                            <div>
                                <span>1234</span>
                                <span>12</span>
                            </div>
                        </div>
                    </div>

                    <div class="details_item_children">
                        <div class="details_item_children_top">
                            <img src="../../../image/pro.png" alt="">
                            <span>微光</span>
                        </div>

                        <div class="details_item_children_con">
                            <div>回复: <span>这活动蛮好的！</span></div>
                        </div>

                        <div class="details_item_children_bottom">
                            <span>田喜碧等人</span>
                            <span @click="repliesHandle()">共34条回复</span>
                        </div>

                        <div class="details_item_children_footer">
                            <span>6-18 23:13</span>
                            <span><img src="../../../image/circle/reply2x.png" alt=""></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="details_comment_footer">
                <div class="details_comment_footer_btn" @click="linkHandle()">{{signStatus}}</div>
            </div>
        </div>
        <!--取消和编辑活动-->
        <div class="details_edit cssFlex" v-if="!edit">
            <div @click="clearActivities()">取消活动</div>
            <div @click="editActivities()">编辑活动</div>
        </div>


        <div class="details_comment_box" :class="comment_box ? '' : 'isDisplay'">
            <textarea v-model="textarea" @input="textInput()" maxlength=300 name="" id="" cols="30" rows="10"
                      placeholder="写评论"></textarea>
            <div class="num_total"><span>{{num}}</span>/300</div>
            <div><span @click="sendHandle()">发送</span></div>
        </div>

        <div id="popover" v-if="popover" @touchmove.prevent>
            <div class="popover_content">
                <form class="mui-input-group">
                    <div class="mui-input-row">
                        <label>用户名:</label>
                        <input type="text" v-model="u_name" class="mui-input-clear" placeholder="请输入姓名">
                    </div>
                    <div class="mui-input-row">
                        <label>手机号:</label>
                        <input type="number" v-model="phone" class="mui-input-clear" placeholder="请输入手机号">
                    </div>
                    <div class="mui-button-row">
                        <button type="button" class="mui-btn mui-btn-primary" @click="confirmHand()">确认</button>
                        <button type="button" class="mui-btn mui-btn-danger" @click="cancel()">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/util.js"></script>
<script type="text/javascript" src="../../../script/kv.js"></script>
<script type="text/javascript" src="../../../script/apiCloud.js"></script>
<script type="text/javascript" src="../../../script/public.js"></script>
<script type="text/javascript" src="../../../script/rem.js"></script>
<script type="text/javascript" src="../../../script/mui.min.js"></script>
<script type="text/javascript" src="../../../script/data.js"></script>
<script src="../../../script/vue.min.js"></script>
<script src="../../../script/vuex.min.js"></script>

<script src="https://cdn.bootcss.com/eruda/1.2.6/eruda.js"></script>
<script>eruda.init();</script>
<script>
    apiready = function () {

        new Vue({
            el: '#details',
            data: {
                isDisplay: false,
                comment_box: false,
                item: {},
                status: 0,
                person_id: '',
                circle_id: '',
                edit: false,
                signStatus: '我要报名',
                num: 0,
                textarea: '',
                u_name: '',
                phone: '',
                popover: false
            },
            created: function () {
                this.person_id = localStorage.getItem('person_id');
                this.circle_id = api.pageParam.circle_id;
                this.edit = api.pageParam.edit;
                this.CircleProfileAllinOne();
            },
            mounted: function () {

                this.isDisplay = true;
            },
            methods: {
                // 获取数据
                CircleProfileAllinOne: function () {
                    var that = this;
                    // console.log(123)
                    ajaxGetWithProgress(CircleProfileAllinOne, {
                        person_id: that.person_id,
                        circle_id: that.circle_id,
                    }, function (data, err) {
                        document.getElementById('box').className = '';
                        console.log(data);
                        if (data.circle_summary) {
                            that.item = data.circle_summary;
                            that.status = data.status;
                        }

                        if (that.status) {
                            that.signStatus = '已报名'
                        }

                    });
                },

                // 点击打开地图
                cityHandle: function (lat, lon, address) {
                    console.log(lat);
                    console.log(lon);
                    console.log(address);
                    this.baiduditu(lat, lon, address);
                },
                // 唤起地图导航
                baiduditu: function (lat, lon, address) {
                    var systemType = api.systemType;
                    var buttons = new Array();
                    var amap_installed = false;
                    var bmap_installed = false;
                    if (systemType == 'ios') {
                        var installed = api.appInstalled({
                            sync: true,
                            appBundle: 'iosamap://'
                        });
                        if (installed) {
                            amap_installed = true;
                            buttons.push('高德地图');
                        }
                        var installed = api.appInstalled({
                            sync: true,
                            appBundle: 'baidumap://'
                        });
                        if (installed) {
                            bmap_installed = true;
                            buttons.push('百度地图');
                        }
                    } else {
                        var installed = api.appInstalled({
                            sync: true,
                            appBundle: 'com.autonavi.minimap'
                        });
                        if (installed) {
                            amap_installed = true;
                            buttons.push('高德地图');
                        }
                        var installed = api.appInstalled({
                            sync: true,
                            appBundle: 'com.baidu.BaiduMap'
                        });
                        if (installed) {
                            bmap_installed = true;
                            buttons.push('百度地图');
                        }
                    }
                    if (bmap_installed == false && amap_installed == false) {
                        api.toast({
                            msg: '您没有安装任何地图软件'
                        });
                        return false;
                    }

                    var address = address;
                    var latbaidu = lat;
                    var lngbaidu = lon;
                    var latgaode = lat;
                    var lnggaode = lon;
                    api.actionSheet({
                        cancelTitle: '取消',
                        buttons: buttons
                    }, function (ret, err) {
                        var index = ret.buttonIndex;

                        switch (index) {
                            case 1:
                                if (amap_installed && bmap_installed) {
                                    if (systemType == 'ios') {
                                        api.openApp({
                                            iosUrl: 'iosamap://path?sourceApplication=applicationName&sid=BGVIS1&did=BGVIS2&dlat=' + latgaode + '&dlon=' + lnggaode + '&dname=' + address + '&dev=0&t=3',
                                        }, function (ret, err) {

                                        });
                                    } else {
                                        api.openApp({
                                            androidPkg: 'android.intent.action.VIEW',
                                            uri: 'amapuri://route/plan/?dlat=' + latgaode + '&dlon=' + lnggaode + '&dname=' + address + '&dev=0&t=3'
                                        }, function (ret, err) {

                                        });
                                    }
                                } else {
                                    if (amap_installed) {
                                        if (systemType == 'ios') {
                                            api.openApp({
                                                iosUrl: 'iosamap://path?sourceApplication=applicationName&sid=BGVIS1&did=BGVIS2&dlat=' + latgaode + '&dlon=' + lnggaode + '&dname=' + address + '&dev=0&t=3',
                                            }, function (ret, err) {

                                            });
                                        } else {
                                            api.openApp({
                                                androidPkg: 'android.intent.action.VIEW',
                                                uri: 'amapuri://route/plan/?dlat=' + latgaode + '&dlon=' + lnggaode + '&dname=' + address + '&dev=0&t=3'
                                            }, function (ret, err) {

                                            });
                                        }

                                    }
                                    if (bmap_installed) {
                                        if (systemType == 'ios') {
                                            api.openApp({
                                                iosUrl: 'baidumap://map/direction?destination=latlng:' + latbaidu + ',' + lngbaidu + '|name:' + address + '&mode=riding',
                                            }, function (ret, err) {
                                                if (err) {

                                                    //alert(JSON.stringify(err));
                                                }
                                            });
                                        } else {
                                            api.openApp({
                                                androidPkg: 'android.intent.action.VIEW',
                                                uri: 'baidumap://map/direction?destination=latlng:' + latbaidu + ',' + lngbaidu + '|name:' + address + '&mode=riding'
                                            }, function (ret, err) {

                                            });
                                        }
                                    }
                                    break;
                                }

                            case 2:
                                if (systemType == 'ios') {
                                    api.openApp({
                                        iosUrl: 'baidumap://map/direction?destination=latlng:' + latbaidu + ',' + lngbaidu + '|name:' + address + '&mode=riding',
                                    }, function (ret, err) {
                                        if (err) {
                                            //alert(JSON.stringify(err));

                                        }
                                    });
                                } else {
                                    api.openApp({
                                        androidPkg: 'android.intent.action.VIEW',
                                        uri: 'baidumap://map/direction?destination=latlng:' + latbaidu + ',' + lngbaidu + '|name:' + address + '&mode=riding'
                                    }, function (ret, err) {
                                        if (err) {
                                            //alert(JSON.stringify(err));
                                        }
                                    });
                                }
                                break;
                        }
                    })
                },

                // 聚焦事件
                focusHandle: function () {
                    // alert(123)
                    this.comment_box = true;
                },

                // 评论文本框input事件
                textInput: function () {
                    this.num = this.textarea.length;
                },

                // 发送
                sendHandle: function () {
                    console.log(this.textarea);
                    this.comment_box = false;
                },

                // 点击查看更多回复
                repliesHandle: function () {

                },

                // 点击报名
                linkHandle: function () {
                    if (this.signStatus == '已报名') {
                        var that = this;
                        openNewWindow("E_ticket", "./E_ticket.html", {
                            circle_id: that.circle_id,
                            person_id: that.item.person_id
                        })
                        return;
                    }
                    this.popover = true;
                },

                // 确认
                confirmHand: function () {
                    var that = this;

                    if (!that.u_name) {
                        mui.toast('请填写姓名');
                        return;
                    }

                    if (!checkMobileNum(that.phone)) {
                        mui.toast('请填写正确的手机号');
                        return;
                    }
                    ajaxGetWithProgress(joinCircle, {
                        circle_id: that.circle_id,
                        person_id: that.item.person_id,
                        u_name: that.u_name,
                        phone: that.phone,
                    }, function (data, err) {

                        console.log(data);
                        if (data.return_info.status) {
                            that.popover = false;
                            that.signStatus = '已报名'
                            openNewWindow("E_ticket", "./E_ticket.html", {
                                circle_id: that.circle_id,
                                person_id: that.item.person_id
                            })
                        }

                    });
                },

                // 取消
                cancel: function () {
                    this.popover = false;
                },

                // 取消活动
                clearActivities: function () {
                    var that = this;
                    mui.confirm('您确定要取消此活动吗?', function (e) {
                        if (e.index) {
                            ajaxGetWithProgress(updateCircle, {
                                cir_status: 0,
                                circle_id: that.circle_id,
                            }, function (data, err) {

                                console.log(data);
                                if (data.return.status) {
                                    mui.toast('活动以取消');
                                    closeWin();
                                }

                            });
                        }
                    })

                },

                // 编辑活动
                editActivities: function () {

                }
            }
        })
    }
</script>
</body>
</html>
