<!DOCTYPE html>
<html lang="en" class="commonBg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>聊天</title>
    <link rel="stylesheet" href="../../../css/api.css" />
    <link rel="stylesheet" href="../../../css/commonWin.css" />
    <link rel="stylesheet" href="../../../css/mui.min.css">
    <link rel="stylesheet" href="../../../css/chatCommon.css">
</head>
<body class="commonBg">


    <div class="Box" id="chat">

        <div id="message">
            <div class="reply">
                <div class="time">05/22 06:30</div>
                <div class="msg">
                    <img src="../../../image/chat/touxiang.png" alt=""/>
                    <span class="name">伯乐</span>
                    <p>
                        <i class="msg_input"></i>
                        您好，请问对这个职位感兴趣吗？
                    </p>
                </div>
            </div>
            <div class="ask">
                <div class="time">05/22 06:30</div>
                <div class="msg">
                    <img src="../../../image/chat/touxiangm.png" alt=""/>
                    <!--<span class="name">千里马</span>-->
                    <p>
                        <i clas="msg_input"></i>
                        您好，我想应聘贵公司的运营经理，
                        期盼回复，谢谢！
                    </p>
                </div>
            </div>
        </div>

        <div id="footer">
            <img src="../../../image/chat/hua.png" alt=""/>
            <img src="../../../image/chat/xiaolian.png" alt=""/>
            <input class="my-input" type="text" v-model="sendInput"/>
            <p class="send" @click="sendHandle()">发送</p>

        </div>
    </div>
    <script type="text/javascript" src="../../../script/api.js"></script>
    <script type="text/javascript" src="../../../script/util.js"></script>
    <script type="text/javascript" src="../../../script/jquery-1.8.1.min.js"></script>
    <script type="text/javascript" src="../../../script/apiCloud.js"></script>
    <script type="text/javascript" src="../../../script/public.js"></script>
    <script type="text/javascript" src="../../../script/rem.js"></script>
    <script type="text/javascript" src="../../../script/mui.min.js"></script>
    <script type="text/javascript" src="../../../script/data.js"></script>

    <script src="../../../script/paho-mqtt.min.js"></script>
    <script src="../../../script/vue.min.js"></script>
    <script src="../../../script/vuex.min.js"></script>

    <script src="https://cdn.bootcss.com/eruda/1.2.6/eruda.js"></script>
    <script>eruda.init();</script>
    <script>
        // //所有主题
        // var allTopics = [
        //     { "Topic": "/data/alarm", "Describe": "报警" },
        //     { "Topic": "/data/message", "Describe": "消息" },
        //     { "Topic": "/data/notify", "Describe": "通知" }
        // ];
        //
        // //选中订阅主题
        // var selectedTopics = [];
        //
        // //选中发布主题
        // var currentTopic;
        //
        // //客户端选项
        // var option = {
        //     "ServerUri": "192.168.1.10",
        //     "ServerPort": 61614,
        //     "UserName": "admin",
        //     "Password": "password",
        //     "ClientId": "",
        //     "TimeOut": 5,
        //     "KeepAlive": 100,
        //     "CleanSession": false,
        //     "SSL":false
        // }
        //
        // //客户端
        // var client;
        //
        // //设置客户端标识
        // option.ClientId = guid();
        //
        // console.log(Paho)
        // client = new Paho.Client(option.ServerUri, option.ServerPort, option.ClientId);
        // client.onConnectionLost = onConnectionLost; //绑定连接断开事件
        // client.onMessageArrived = onMessageArrived; //绑定接收消息事件
        // //连接服务端
        // client.connect({
        //     invocationContext: {
        //         host: option.ServerUri,//IP地址
        //         port: option.ServerPort,//端口号
        //         path: client.path,
        //         clientId: option.ClientId//标识
        //     },
        //     timeout: option.TimeOut,//连接超时时间
        //     keepAliveInterval: option.KeepAlive,//心跳间隔
        //     cleanSession: option.CleanSession,//是否清理Session
        //     useSSL: option.SSL,//是否启用SSL
        //     userName: option.UserName,  //用户名
        //     password: option.Password,  //密码
        //     onSuccess: onConnect,//连接成功回调事件
        //     onFailure: onError//连接失败回调事件
        // });
        //
        // //连接成功回调事件
        // function onConnect() {
        //     // Once a connection has been made, make a subscription and send a message.
        //     console.log("连接成功了");
        //     client.subscribe("yang");
        //     var message = new Paho.Message("Hello");
        //     message.destinationName = "/World";
        //     client.send(message);
        // };
        // //连接失败回调事件
        // function onError(e) {
        //     console.log("连接失败：" + e)
        // }
        // //连接断开事件
        // function onConnectionLost(responseObject) {
        //     if (responseObject.errorCode !== 0)
        //         console.log("onConnectionLost:"+responseObject.errorMessage);
        // };
        // //接收消息事件
        // function onMessageArrived(message) {
        //     console.log(message)
        //     console.log("onMessageArrived:"+message.payloadString);
        //     console.log("topic:"+message.topic);
        //     // client.disconnect();
        // };
        //
        // //生成GUID
        // function guid() {
        //     function S4() {
        //         return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        //     }
        //     return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        // }
    </script>

    <script>
        apiready = function () {

            new Vue({
                el: '#chat',
                data: {
                    isDisplay: false,
                    active: 'contacts',
                    list: [],
                    //客户端选项
                    option: {
                        "ServerUri": "192.168.1.10",
                        "ServerPort": 61614,
                        "UserName": "admin",
                        "Password": "password",
                        "ClientId": "",
                        "TimeOut": 5,
                        "KeepAlive": 100,
                        "CleanSession": false,
                        "SSL": false
                    },
                    //选中订阅主题
                    selectedTopics: [],
                    //选中发布主题
                    currentTopic: [],
                    //客户端
                    client: {},
                    token: '',
                    ptoken: '',
                    t_key: '',
                    canSend: false,

                    sendInput: '',
                    result: '',
                    type: ''
                },
                created: function () {
                    // this.token = api.pageParam.token;
                    this.token = 1;
                    // this.ptoken = api.pageParam.ptoken;
                    this.ptoken = 2;
                    this.t_key = api.pageParam.t_key;

                    this.addTopic();
                },
                mounted: function () {
                    this.isDisplay = true;
                    var that = this;
                    $('#footer').on('keyup', 'input', function() {
                        if ($(this).val().length > 0) {
                            $(this).next().css('background', '#114F8E').prop('disabled', true);
                            that.canSend = true;
                        } else {
                            $(this).next().css('background', '#ddd').prop('disabled', false);
                            that.canSend = false;
                        }
                    })
                    // $('#footer .send').click(that.send())
                    $("#footer .my-input").keydown(function(e){
                        if(e.keyCode == 13){
                            return that.send();
                        }
                    });
                    // var arr = ['你在想我么', '怎么不和我说话', '跟我聊会天吧'];
                    // test()
                    // function test() {
                    //     $(arr).each(function(i) {
                    //         setTimeout(function() {
                    //             reply("../image/chat/touxiang.png", arr[i])
                    //         }, sj() * 500)
                    //     })
                    // }

                    // function reply(headSrc, str) {
                    //     var html = "<div class='reply'><div class='msg'><img src=" + headSrc + " /><span class='name'>斜杠青年</span><p><i class='msg_input'></i>" + str + "</p></div></div>";
                    //     return upView(html);
                    // }
                    // function ask(headSrc, str) {
                    //     var html = "<div class='ask'><div class='msg'><img src=" + headSrc + " />" + "<p><i class='msg_input'></i>" + str + "</p></div></div>";
                    //     return upView(html);
                    // }
                    // function upView(html) {
                    //     var message = $('#message');
                    //     message.append(html);
                    //     return $('html,body').animate({
                    //         scrollTop: message.outerHeight() - window.innerHeight
                    //     }, 200);
                    // }
                    // function send(msg){
                    //     if(canSend){
                    //         let input = $("#footer .my-input");
                    //         ask("../image/chat/touxiangm.png", input.val());
                    //         input.val('');
                    //         test();
                    //     }
                    // }
                    // function sj() {
                    //     return parseInt(Math.random() * 10)
                    // }
                },
                methods: {
                    // 发送
                    sendHandle: function () {
                        console.log(this.t_key);
                        var html = "<div class='ask'><div class='msg'><img src='../image/chat/touxiang.png' />" + "<p><i class='msg_input'></i>" + this.sendInput + "</p></div></div>";
                        var message = $('#message');
                        message.append(html);
                        $('html,body').animate({
                            scrollTop: message.outerHeight() - window.innerHeight
                        }, 200);

                        var message = new Paho.Message(this.sendInput);
                        message.destinationName = this.t_key;
                        this.client.send(message);

                    },
                    // 获取订阅号id
                    addTopic: function () {
                        var that = this;
                        ajaxGet(addTopic, {
                            token: that.token,
                            ptoken: that.ptoken,
                            t_key: that.t_key,
                        }, function (data, err) {
                            console.log(data);
                            if (data.My_Topic) {
                                that.t_key = data.My_Topic.t_key;
                                that.sendMQTT(that.t_key);
                            }
                        });
                    },
                    // 配置链接mqtt服务
                    sendMQTT: function (){
                        //设置客户端标识
                        this.option.ClientId = this.guid();

                        this.client = new Paho.Client(this.option.ServerUri, this.option.ServerPort, this.option.ClientId);
                        this.client.onConnectionLost = this.onConnectionLost; //绑定连接断开事件
                        this.client.onMessageArrived = this.onMessageArrived; //绑定接收消息事件
                        //连接服务端
                        this.client.connect({
                            invocationContext: {
                                host: this.option.ServerUri,//IP地址
                                port: this.option.ServerPort,//端口号
                                path: this.client.path,
                                clientId: this.option.ClientId//标识
                            },
                            timeout: this.option.TimeOut,//连接超时时间
                            keepAliveInterval: this.option.KeepAlive,//心跳间隔
                            cleanSession: this.option.CleanSession,//是否清理Session
                            useSSL: this.option.SSL,//是否启用SSL
                            userName: this.option.UserName,  //用户名
                            password: this.option.Password,  //密码
                            onSuccess: this.onConnect,//连接成功回调事件
                            onFailure: this.onError//连接失败回调事件
                        });
                    },
                    //连接成功回调事件
                    onConnect: function () {
                        console.log("连接成功了",this.token, this.ptoken, this.t_key);
                        this.client.subscribe(this.t_key);

                    },
                    //连接失败回调事件
                    onError: function (e) {
                        console.log("连接失败：" + e)
                    },
                    //连接断开事件
                    onConnectionLost: function (responseObject) {
                        if (responseObject.errorCode !== 0)
                            console.log("onConnectionLost:" + responseObject.errorMessage);
                    },
                    //接收消息事件
                    onMessageArrived: function (message) {
                        console.log(message)
                        console.log("onMessageArrived:" + message.payloadString);
                        this.result = message.payloadString;
                        var html = "<div class='ask'><div class='msg'><img src='../image/chat/touxiang.png' />" + "<p><i class='msg_input'></i>" + message.payloadString + "</p></div></div>";
                        var message = $('#message');
                        message.append(html);
                        $('html,body').animate({
                            scrollTop: message.outerHeight() - window.innerHeight
                        }, 200);
                        // 断开连接
                        // this.client.disconnect();
                    },
                    //生成GUID
                    guid: function () {
                        function S4() {
                            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
                        }

                        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
                    }
                }
            })
        }

        // apiready();
    </script>
</body>
</html>
